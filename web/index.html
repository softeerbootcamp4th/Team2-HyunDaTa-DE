<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Untree.co">
    <link rel="shortcut icon" href="images/favicon.png">
    <meta name="description" content="" />
    <meta name="keywords" content="bootstrap, bootstrap5" />
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="fonts/icomoon/style.css">
    <link rel="stylesheet" href="fonts/flaticon/font/flaticon.css">
    <link rel="stylesheet" href="css/tiny-slider.css">
    <link rel="stylesheet" href="css/aos.css">
    <link rel="stylesheet" href="css/glightbox.min.css">
    <link rel="stylesheet" href="css/style.css">
    <title>HyunDaTa</title>
</head>
<body>

    <div class="site-mobile-menu site-navbar-target">
        <div class="site-mobile-menu-header">
            <div class="site-mobile-menu-close">
                <span class="icofont-close js-menu-toggle"></span>
            </div>
        </div>
        <div class="site-mobile-menu-body"></div>
    </div>

    <nav class="site-nav">
        <div class="container">
            <div class="site-navigation">
                <a href="index.html" class="logo m-0 float-start">
                    <img src="images/HyunDaTa_Image_width.png" alt="HyunDaTa Logo" style="height: 90px; margin-top: -13px;">
                </a>
                <ul class="js-clone-nav d-none d-lg-inline-block text-start site-menu float-start">
                    <li class="active">
                        <a href="index.html?exception_mode=hot_issue" style="font-size: 30px;">
                            <img src="images/siren_1.png" alt="Siren" class="siren-icon-left">
                            Hot Issue
                            <img src="images/siren_1.png" alt="Siren" class="siren-icon-left">
                        </a>
                    </li>
                    
                    <li class="has-children">
                        <a href="index.html" style="font-size: 30px;">Vehicle</a>
                        <ul class="dropdown">
                            <li><a href="index.html?car_name=아반떼">아반떼</a></li>
                            <li><a href="index.html?car_name=소나타">소나타</a></li>
                            <li><a href="index.html?car_name=그랜저">그랜저</a></li>
                            <li><a href="index.html?car_name=제네시스">제네시스</a></li>
                            <li><a href="index.html?car_name=아이오닉">아이오닉</a></li>
                            <li><a href="index.html?car_name=캐스퍼">캐스퍼</a></li>
                            <li><a href="index.html?car_name=팰리세이드">팰리세이드</a></li>
                        </ul>
                    </li>                    
                </ul>
            </div>
        </div>
    </nav>

    <div class="hero-2 overlay" style="background-image: url('images/ioniq_2.jpg');">
        <div class="container">
            <div class="defect-list-container">
                <div id="defectList" class="defect-list"></div>
            </div>
            <div class="hot-issue-list-container">
                <div id="hotIssueList" class="hot-issue-list"></div>
            </div>
            <div class="row align-items-center" id="main-content">
                <div class="summary-section-class" id="summary-section">
                </div>
                
                <div class="col-lg-5 mx-auto" id="intro-section">
                    <h1 class="mb-5"><span>We are</span> <span class="d-block">HyunDaTa</span> <span class="d-block">providing alert service</span></h1>
    
                    <div class="play-vid">
                        <a href="https://www.youtube.com/watch?v=dXSbtE5ZfhM" class="play glightbox">
                            <span class="icon-play"></span>
                        </a>
                    </div>
                </div>

                <div class="col-lg-8 mx-auto" id="chart-section">
                    <canvas id="issueChart"></canvas>
                </div>                                
            </div>
        </div>
    </div>

    <div class="site-footer bg-light">
        <div class="container">
            <div class="row justify-content-between">
                <div class="col-lg-4">
                    <div class="widget">
                        <h3 class="line-top">About HyunDaTa</h3>
                        <p class="mb-5">HyunDaTa specializes in creating efficient data pipelines that deliver periodic insights and automated alerts. Our mission is to transform raw data into actionable intelligence, enabling businesses to make informed decisions with confidence. We provide scalable and reliable solutions tailored to meet the unique needs of Hyundai Motor Company, driving success through innovation in data management.</p>
                    </div>
                    <div class="widget">
                        <h3 class="line-top">Connect with us</h3>
                        <ul class="social list-unstyled mb-5">
                            <li><a href="https://www.instagram.com/hyundata_official/"><span class="icon-instagram"></span></a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="row justify-content-center text-center copyright">
                <div class="col-md-8">
                    <p class="small text-black-50">Copyright &copy;<script>document.write(new Date().getFullYear());</script>. All Rights Reserved. &mdash; Designed with love by <a href="https://untree.co">Untree.co</a></br>Distributed By <a href="https://themewagon.com/">Themewagon</a> <a>Designed by Freepik</a><!-- License information: https://untree.co/license/ -->
                    </p>
                </div>
            </div>
        </div>
    </div>
    <div id="overlayer"></div>
    <div class="loader">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@latest/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/tiny-slider.js"></script>
    <script src="js/aos.js"></script>
    <script src="js/glightbox.min.js"></script>
    <script src="js/navbar.js"></script>
    <script src="js/counter.js"></script>
    <script src="js/custom.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const exceptionMode = urlParams.get('exception_mode');
            let car_name = urlParams.get('car_name');
            let issue = urlParams.get('issue');
            car_name = car_name ? car_name.toLowerCase() : null;
            issue = issue ? issue.toLowerCase() : null;

            const defectListContainer = document.querySelector('.defect-list-container');
            const hotIssueListContainer = document.querySelector('.hot-issue-list-container');

            if (exceptionMode === 'hot_issue') {
                hotIssueListContainer.style.display = 'block';
                defectListContainer.style.display = 'none';
            } else {
                if (car_name) {
                    defectListContainer.style.display = 'block';

                    const defectList = document.getElementById('defectList');
                    const defectTypes = [
                        "ICCU", "가속", "급발진", "냉각수누수", "녹/부식", "누수", "누유", "단차", "도어잠금", "떨림", "방전", 
                        "배기", "배터리", "변속기", "브레이크패드", "서스펜션", "소프트웨어", "스티어링", "시동", "안전벨트", 
                        "에어백", "에어컨", "엔진", "엔진소음", "연료누출", "와이퍼", "전기", "전방 센서", "제동", "조명", 
                        "차선이탈경고시스템", "코팅", "타이어", "트렁크", "핸들", "후방카메라", "히터"
                    ];

                    defectTypes.forEach(defect => {
                        const defectLink = document.createElement('a');
                        defectLink.href = `index.html?car_name=${car_name}&issue=${defect.toLowerCase()}`;
                        defectLink.textContent = defect;
                        defectList.appendChild(defectLink);
                    });
                }

                if (car_name && issue) {
                    const apiUrl = `/api/data?car_name=${car_name}&issue=${issue}`;

                    fetch(apiUrl)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Server error: ' + response.status);
                            }
                            return response.json();
                        })
                        .then(data => {
                            const chartSection = document.getElementById('chart-section');
                            if (data.error || !data.labels || data.labels.length === 0) {
                                chartSection.style.display = 'none';
                            } else {
                                chartSection.style.display = 'block';
                                renderChart(data);
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching data:', error);
                            document.getElementById('chart-section').style.display = 'none';
                        });
                }
            }
        });

        function renderChart(data) {
            const canvas = document.getElementById('issueChart');
            if (!canvas) {
                console.error("Cannot find the canvas element with id 'issueChart'.");
                return;
            }
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error("Cannot get the context for the canvas.");
                return;
            }
            const summarySection = document.getElementById('summary-section');
            if (data.today_data) {
                const today = new Date();
                const formattedDate = today.toISOString().split('T')[0];
                const linkHtml = data.url 
                    ? `<a href="${data.url}" target="_blank" class="link-button">
                        <img src="/images/check.png" alt="Check Icon">
                        결함 게시물 바로가기
                    </a>`
                    : `<span class="link-button-disabled">
                        <img src="/images/check.png" alt="Check Icon">
                        결함 게시물 바로가기
                    </span>`;
                const summaryText = `
                    <div class="summary-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <p class="summary-date-car-issue" style="margin-right: auto;">
                            ${formattedDate}&nbsp;&nbsp;&nbsp;${data.today_data.car_name} - ${data.today_data.single_issue}
                        </p>
                        ${linkHtml}
                    </div>
                    <div class="row stat-cards">
                        <div class="col-md-6 col-xl-3">
                            <article class="stat-cards-item">
                                <div class="stat-cards-icon post">
                                    <img src="images/Post.png" alt="Post Icon">
                                </div>
                                <div class="stat-cards-info">
                                    <p class="stat-cards-info__num">${data.today_data.num_posts}</p>
                                    <p class="stat-cards-info__title">결함 게시물 수</p>
                                </div>
                            </article>
                        </div>
                        <div class="col-md-6 col-xl-3">
                            <article class="stat-cards-item">
                                <div class="stat-cards-icon like">
                                    <img src="images/Like.png" alt="Like Icon">
                                </div>
                                <div class="stat-cards-info">
                                    <p class="stat-cards-info__num">${data.today_data.total_likes}</p>
                                    <p class="stat-cards-info__title">결함 좋아요 수</p>
                                </div>
                            </article>
                        </div>
                        <div class="col-md-6 col-xl-3">
                            <article class="stat-cards-item">
                                <div class="stat-cards-icon view">
                                    <img src="images/View.png" alt="View Icon">
                                </div>
                                <div class="stat-cards-info">
                                    <p class="stat-cards-info__num">${data.today_data.total_views}</p>
                                    <p class="stat-cards-info__title">결함 조회 수</p>
                                </div>
                            </article>
                        </div>
                        <div class="col-md-6 col-xl-3">
                            <article class="stat-cards-item">
                                <div class="stat-cards-icon comment">
                                    <img src="images/Comment.png" alt="Comment Icon">
                                </div>
                                <div class="stat-cards-info">
                                    <p class="stat-cards-info__num">${data.today_data.issue_mentions}</p>
                                    <p class="stat-cards-info__title">결함 언급 수</p>
                                </div>
                            </article>
                        </div>
                    </div>
                `;
                summarySection.innerHTML = summaryText;
                summarySection.style.display = 'block';
            } else {
                const noDataText = `<span class="summary-no-data">
                                        금일 결함 이슈가 없습니다. 휴~&nbsp;&nbsp;
                                        <img src="images/no_issue.jpg" alt="No Issue" class="no-issue-image">
                                    </span>`;
                summarySection.innerHTML = noDataText;
                summarySection.style.display = 'block';
            }
            const annotationLines = data.vertical_lines.map(line => ({
            id: `annotation-${line.label}`,
            type: 'line',
            scaleID: 'x',
            value: line.date,
            borderColor: line.color,
            borderWidth: 2,
            label: {
                content: line.label,
                enabled: true,
                position: 'start',
                backgroundColor: line.color,
                color: '#fff'
            }
            }));
            if (window.issueChart && window.issueChart.data && window.issueChart.options) {
                window.issueChart.data.labels = data.labels || [];
                window.issueChart.data.datasets = data.datasets || [];
                if (window.issueChart.options.plugins && window.issueChart.options.plugins.annotation) {
                    window.issueChart.options.plugins.annotation.annotations = annotationLines;
                } else {
                    console.error("window.issueChart.options.plugins.annotation is undefined");
                }
                window.issueChart.update();
            } else {
                window.issueChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels || [],
                        datasets: data.datasets || []
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        },
                        elements: {
                            line: {
                                tension: 0.4
                            }
                        },
                        spanGaps: true,
                        plugins: {
                            annotation: {
                                annotations: annotationLines
                            },
                            legend: {
                                onClick: function (e, legendItem) {
                                    const chart = this.chart;
                                    const index = legendItem.datasetIndex;
                                    if (index === undefined || index === null) {
                                        console.error('No dataset index found in legendItem', legendItem);
                                        return;
                                    }
                                    if (!chart) {
                                        console.error('Chart instance not found');
                                        return;
                                    }
                                    const meta = chart.getDatasetMeta(index);
                                    if (!meta) {
                                        console.error('No dataset meta found for index:', index);
                                        return;
                                    }
                                    meta.hidden = meta.hidden === null ? !chart.data.datasets[index].hidden : null;
                                    const datasetLabel = chart.data.datasets[index].label;
                                    const parts = datasetLabel.split(" (")[0];
                                    const annotationId = `annotation-news: ${parts}`;
                                    const matchingAnnotations = chart.options.plugins.annotation.annotations.filter(ann => ann.id === annotationId);
                                    matchingAnnotations.forEach(annotation => {
                                        annotation.display = !meta.hidden;
                                    });
                                    chart.update();
                                }
                            }
                        },
                    }
                });
            }
        }

    </script>
    <script>
        (function () {
            'use strict';

            AOS.init({
                duration: 800,
                easing: 'slide',
                once: true
            });

            var preloader = function () {
                var loader = document.querySelector('.loader');
                var overlay = document.getElementById('overlayer');

                function fadeOut(el) {
                    el.style.opacity = 1;
                    (function fade() {
                        if ((el.style.opacity -= .1) < 0) {
                            el.style.display = "none";
                        } else {
                            requestAnimationFrame(fade);
                        }
                    })();
                }

                setTimeout(function () {
                    fadeOut(loader);
                    fadeOut(overlay);
                }, 200);
            };
            preloader();

            var tinyslier = function () {
                var heroSlider = document.querySelectorAll('.hero-slide');
                var propertySlider = document.querySelectorAll('.property-slider');
                var imgPropertySlider = document.querySelectorAll('.img-property-slide');
                var testimonialCenter = document.querySelectorAll('.testimonial-center');

                if (heroSlider.length > 0) {
                    var tnsHeroSlider = tns({
                        container: '.hero-slide',
                        mode: 'carousel',
                        speed: 700,
                        autoplay: true,
                        controls: false,
                        nav: false,
                        autoplayButtonOutput: false,
                        controlsContainer: '#hero-nav',
                    });
                }

                if (imgPropertySlider.length > 0) {
                    var tnsPropertyImageSlider = tns({
                        container: '.img-property-slide',
                        mode: 'carousel',
                        speed: 700,
                        items: 1,
                        autoplay: true,
                        controls: false,
                        nav: true,
                        autoplayButtonOutput: false
                    });
                }

                if (propertySlider.length > 0) {
                    var tnsSlider = tns({
                        container: '.property-slider',
                        mode: 'carousel',
                        speed: 700,
                        items: 3,
                        autoplay: true,
                        autoplayButtonOutput: false,
                        controlsContainer: '#property-nav',
                        responsive: {
                            0: {
                                items: 1
                            },
                            700: {
                                items: 2
                            },
                            900: {
                                items: 3
                            }
                        }
                    });
                }
                if (testimonialCenter.length > 0) {
                    var testimonialSlider = tns({
                        container: '#testimonial-center',
                        items: 1,
                        mode: 'carousel',
                        slideBy: 'page',
                        nav: true,
                        controls: true,
                        autoplay: true,
                        autoplayButtonOutput: false,
                        controls: true,
                        gutter: 50,
                        slideBy: 1,
                        edgePadding: 0,
                        center: true,
                        controlsContainer: '#testimonial-nav',
                        autoplayHoverPause: true,
                        loop: true,
                        swipeAngle: false,
                        speed: 700,
                        responsive: {
                            350: {
                                gutter: 10,
                                edgePadding: 0,
                                items: 1,
                            },
                            500: {
                                gutter: 20,
                                edgePadding: 0,
                                items: 1,
                            },
                            700: {
                                gutter: 50,
                                edgePadding: 20,
                                items: 2,
                            },
                            1000: {
                                gutter: 50,
                                edgePadding: 50,
                                items: 2,
                            }
                        }
                    });
                }

            }
            tinyslier();

            var lightboxVideo = GLightbox({
                selector: '.glightbox'
            });
            
            function loadVehicleData() {
                fetch('/api/config')
                    .then(response => response.json())
                    .then(config => {
                        const vehicles = config.vehicles;

                        const urlParams = new URLSearchParams(window.location.search);
                        const vehicleName = urlParams.get('car_name');
                        const issue = urlParams.get('issue');

                        if (vehicles[vehicleName]) {
                            const vehicle = vehicles[vehicleName];

                            document.querySelector('.hero-2').style.backgroundImage = `url(${vehicle.image})`;
                            document.querySelector('title').innerText = `${vehicle.name} | HyunDaTa`;

                            if (issue) {
                                fetch(`/api/data?car_name=${vehicleName}&issue=${issue}`)
                                    .then(response => response.json())
                                    .then(data => {
                                        const chartSection = document.getElementById('chart-section');
                                        chartSection.style.display = 'block';
                                        
                                        if (data.error) {
                                            console.error(data.error);
                                            chartSection.innerHTML = "<h2 style='font-size: 48px; color: white; text-align: center;'>이슈가 없습니다.</h2>";
                                            return;
                                        }
                                        renderChart(data);
                                    })
                                    .catch(error => {
                                        console.error('Error fetching data:', error);
                                        document.getElementById('chart-section').innerHTML = "<h2 style='font-size: 48px; color: white; text-align: center;'>이슈가 없습니다.</h2>";
                                    });
                            }
                        } else {
                            console.error("차량 데이터를 찾을 수 없습니다.");
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching config data:', error);
                    });
            }
            document.addEventListener('DOMContentLoaded', () => {
                loadVehicleData();
            });
        })();
    </script>
</body>
</html>
