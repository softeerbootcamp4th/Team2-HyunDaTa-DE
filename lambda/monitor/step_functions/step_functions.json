{
  "Comment": "크롤링 람다를 시간 -> 커뮤니티 -> 자동차 순서로 중첩된 루프로 실행하는 Step Function",
  "StartAt": "TimeRangeLoop",
  "States": {
    "TimeRangeLoop": {
      "Type": "Map",
      "MaxConcurrency": 0,
      "ItemsPath": "$.time_range_inputs",
      "Parameters": {
        "time_range.$": "$$.Map.Item.Value",
        "communities.$": "$.communities",
        "car_names.$": "$.car_names"
      },
      "Iterator": {
        "StartAt": "GetTimeRange",
        "States": {
          "GetTimeRange": {
            "Type": "Task",
            "Resource": "arn:aws:lambda:ap-northeast-2:{my_id}:function:get-crawling-time-range",
            "Parameters": {
              "start_hours_ago.$": "$.time_range.start_hours_ago",
              "duration_hours.$": "$.time_range.duration_hours"
            },
            "ResultPath": "$.time_range_output",
            "Next": "CommunityLoop"
          },
          "CommunityLoop": {
            "Type": "Map",
            "MaxConcurrency": 0,
            "ItemsPath": "$.communities",
            "Parameters": {
              "start_datetime.$": "$.time_range_output.start_datetime",
              "end_datetime.$": "$.time_range_output.end_datetime",
              "community.$": "$$.Map.Item.Value",
              "car_names.$": "$.car_names"
            },
            "Iterator": {
              "StartAt": "CarNameLoop",
              "States": {
                "CarNameLoop": {
                  "Type": "Map",
                  "MaxConcurrency": 0,
                  "ItemsPath": "$.car_names",
                  "Parameters": {
                    "start_datetime.$": "$.start_datetime",
                    "end_datetime.$": "$.end_datetime",
                    "community.$": "$.community",
                    "car_name.$": "$$.Map.Item.Value"
                  },
                  "Iterator": {
                    "StartAt": "ProcessCombination",
                    "States": {
                      "ProcessCombination": {
                        "Type": "Task",
                        "Resource": "arn:aws:lambda:ap-northeast-2:{my_id}:function:monitor-community",
                        "End": true
                      }
                    }
                  },
                  "End": true
                }
              }
            },
            "End": true
          }
        }
      },
      "End": true
    }
  }
}
